---
- hosts: localhost

  tasks:
    # This ensures idempotency checks provide better results
    - name: Install Helm Diff plugin
      kubernetes.core.helm_plugin:
        state: present
        plugin_path: https://github.com/databus23/helm-diff

    - name: Add cert-manager Helm repository
      tags:
        - cert-manager
      kubernetes.core.helm_repository:
        state: present
        name: jetstack
        repo_url: https://charts.jetstack.io
        kubeconfig: ../outputs/kubeconfig.yaml

    - name: Install cert-manager
      tags:
        - cert-manager
      kubernetes.core.helm:
        state: present
        name: cert-manager
        chart_ref: jetstack/cert-manager
        release_namespace: cert-manager
        create_namespace: true
        values:
          installCRDs: 'true'
        kubeconfig: ../outputs/kubeconfig.yaml

    - name: Apply DigitalOcean DNS Secret
      tags:
        - cert-manager
      kubernetes.core.k8s:
        state: present
        template: '../../cert-manager/digitalocean-dns-secret.yaml.j2'
        kubeconfig: ../outputs/kubeconfig.yaml
      vars:
        access_token: "{{ lookup('community.general.onepassword', 'DigitalOcean K3s API Token', field='token', vault='Private') }}"

    - name: Apply LetsEncrypt Issuer
      tags:
        - cert-manager
      kubernetes.core.k8s:
        state: present
        template: '../../cert-manager/letsencrypt-issuer.yaml.j2'
        kubeconfig: ../outputs/kubeconfig.yaml
      vars:
        email: "{{ lookup('community.general.onepassword', 'K3s LetsEncrypt Issuer', field='email', vault='Private') }}"

    - name: Configure Traefik
      tags:
        - traefik
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: helm.cattle.io/v1
          kind: HelmChartConfig
          metadata:
            name: traefik
            namespace: kube-system
          spec:
            valuesContent: |-
              ports:
                websecure:
                  tls:
                    enabled: true

                web:
                  redirectTo: 
                    port: websecure
        kubeconfig: ../outputs/kubeconfig.yaml

    - name: Add Longhorn Helm repository
      tags:
        - longhorn
      kubernetes.core.helm_repository:
        state: present
        name: longhorn
        repo_url: https://charts.longhorn.io
        kubeconfig: ../outputs/kubeconfig.yaml

    - name: Install Longhorn
      tags:
        - longhorn
      kubernetes.core.helm:
        state: present
        name: longhorn
        chart_ref: longhorn/longhorn
        release_namespace: longhorn-system
        create_namespace: true
        values:
          defaultSettings:
            defaultDataPath: '/storage01'
        kubeconfig: ../outputs/kubeconfig.yaml

    - name: Apply Longhorn Ingress
      tags:
        - longhorn
      kubernetes.core.k8s:
        state: present
        definition: "{{ lookup('template', '../../longhorn/longhorn-ingress.yml') | from_yaml }}"
        kubeconfig: ../outputs/kubeconfig.yaml

    - name: Make Longhorn storage class the default
      tags:
        - longhorn
      kubernetes.core.k8s:
        state: patched
        kind: StorageClass
        name: local-path
        definition:
          metadata:
            annotations:
              storageclass.kubernetes.io/is-default-class: 'false'

    - name: Add CloudNativePG Helm repository
      tags:
        - cnpg
      kubernetes.core.helm_repository:
        state: present
        name: cnpg
        repo_url: https://cloudnative-pg.github.io/charts
        kubeconfig: ../outputs/kubeconfig.yaml

    - name: Install CloudNativePG (cnpg)
      tags:
        - cnpg
      kubernetes.core.helm:
        state: present
        name: cnpg
        chart_ref: cnpg/cloudnative-pg
        release_namespace: cnpg-system
        create_namespace: true
        kubeconfig: ../outputs/kubeconfig.yaml
